{% extends "base.html" %}

{% block title %}Analysis Results - Crop Disease Detection{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-chart-bar"></i> Analysis Results</h2>
                <div>
                    <a href="{{ url_for('upload_file') }}" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload Another
                    </a>
                    {% if result.results_dir %}
                    <a href="{{ url_for('download_results', results_dir=result.results_dir.split('/')[-1]) }}" 
                       class="btn btn-success">
                        <i class="fas fa-download"></i> Download Results
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- File Information -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-file-alt"></i> File Information</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Filename:</strong> {{ filename }}</p>
                            <p><strong>File Type:</strong> {{ result.metadata.file_type|upper }}</p>
                            <p><strong>File Size:</strong> {{ "%.2f"|format(result.metadata.file_size_mb) }} MB</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Original Shape:</strong> {{ result.metadata.original_shape }}</p>
                            <p><strong>Processed Shape:</strong> {{ result.metadata.processed_shape }}</p>
                            <p><strong>Data Range:</strong> {{ "%.3f"|format(result.metadata.data_range[0]) }} - {{ "%.3f"|format(result.metadata.data_range[1]) }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-primary">{{ result.summary.total_samples }}</h3>
                    <p class="card-text">Total Samples</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-success">{{ result.summary.healthy_samples }}</h3>
                    <p class="card-text">Healthy</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-danger">{{ result.summary.diseased_samples }}</h3>
                    <p class="card-text">Diseased</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center">
                <div class="card-body">
                    <h3 class="text-info">{{ "%.1f"|format(result.summary.average_confidence * 100) }}%</h3>
                    <p class="card-text">Avg Confidence</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Visualizations -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line"></i> Analysis Visualizations</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for viz_name, viz_data in result.visualizations.items() %}
                        <div class="col-md-6 mb-3">
                            <h6>{{ viz_name.replace('_', ' ').title() }}</h6>
                            <img src="{{ viz_data }}" class="img-fluid" alt="{{ viz_name }}">
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Results -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Detailed Predictions</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Sample</th>
                                    <th>Prediction</th>
                                    <th>Confidence</th>
                                    <th>Disease Probability</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pred in result.predictions %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        {% if pred.prediction == 1 %}
                                            <span class="badge bg-danger">Diseased</span>
                                        {% else %}
                                            <span class="badge bg-success">Healthy</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set conf = pred.get('confidence', 0) %}
                                        <span class="{% if conf > 0.8 %}confidence-high{% elif conf > 0.6 %}confidence-medium{% else %}confidence-low{% endif %}">
                                            {{ "%.3f"|format(conf) }}
                                        </span>
                                    </td>
                                    <td>{{ "%.3f"|format(pred.get('disease_probability', 0)) }}</td>
                                    <td>
                                        {% set conf = pred.get('confidence', 0) %}
                                        {% if conf > 0.8 %}
                                            <i class="fas fa-check-circle text-success"></i> High Confidence
                                        {% elif conf > 0.6 %}
                                            <i class="fas fa-exclamation-circle text-warning"></i> Medium Confidence
                                        {% else %}
                                            <i class="fas fa-question-circle text-danger"></i> Low Confidence
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Summary -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clipboard-check"></i> Analysis Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Detection Statistics:</h6>
                            <ul>
                                <li>Disease Rate: {{ "%.1f"|format(result.summary.disease_percentage) }}%</li>
                                <li>High Confidence Predictions: {{ result.summary.high_confidence_predictions }}</li>
                                <li>Low Confidence Predictions: {{ result.summary.low_confidence_predictions }}</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Confidence Range:</h6>
                            <ul>
                                <li>Minimum: {{ "%.3f"|format(result.summary.confidence_range[0]) }}</li>
                                <li>Maximum: {{ "%.3f"|format(result.summary.confidence_range[1]) }}</li>
                                <li>Average: {{ "%.3f"|format(result.summary.average_confidence) }}</li>
                            </ul>
                        </div>
                    </div>
                    
                    {% if result.summary.low_confidence_predictions > 0 %}
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Note:</strong> {{ result.summary.low_confidence_predictions }} predictions have low confidence (&lt;0.6). 
                        Consider additional validation for these samples.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}